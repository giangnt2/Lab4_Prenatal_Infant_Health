---
title: "Lab 4: Does Prenatal Care Improve Infant Health?"
author: "Carmen Easterwood, James Nguyen"
date: "April 23, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("bwght_w203.Rdata")
library(lattice)
library(caret)
library(lmtest)
library(sandwich)
library(corrplot)
library(scales)


```

# Introduction

# Exploratory Data Analysis

```{r}
# Clean up NA values 
v = na.exclude(data, complete.cases(v))

#Mom
hist(v$mage) #Very normal, avg late 20s
hist(v$magesq) #Slightly right skewed
hist(v$meduc) #Spikes at 12 and 16
hist(v$cigs) #Big mass at 0. Right skewed. Above 20, corresponds to packs.
hist(v$drink) #Big mass at 0. Right skewed.

#Dad
hist(v$fage) #Slight right skew, avg early 30s
hist(v$feduc) #Spikes at 12 and 16

#Prenatal care
hist(v$monpre) #Majority begin in first 2 months; right skewed
hist(v$npvis) #Spike at 10-15 visits
hist(v$npvissq) #Right skewed

#Baby
hist(v$bwght) #Normalish, avg 3000-3500 grams (6.6-7.7 lbs)
hist(v$lbwght) #Bit left skewed
hist(v$omaps) #Left skewed, almost all 8 or 9
hist(v$fmaps) #Left skewed, almost all 9
table(v$lbw) #Only 30 lbw (1.6%)
table(v$vlbw) #Only 13 vlbw (0.7%)
table(v$male) #941 male (51.4%)
```

Our dataset contains data on the race of both the father and mother of the baby, in the form of indicator variables for "white", "black", and "other" races. For illustrative purposes, we combine the indicator variables into a single "race" variable for each parent, which allows us to view a table of the parents' races. Two things stand out in this table:

1. Almost 90% of parents in this dataset are white.
2. Over 95% of couples lie along the diagonal of the table, which means the mother and father are the same race.

```{r}
#Race Table
mrace <- as.factor(c())
levels(mrace) <- c("white", "black", "other")

for (i in 1:length(v$bwght)){
  if (v[i,]$mwhte == 1) {mrace[i] <- "white"}
  else if (v[i,]$mblck == 1) {mrace[i] <- "black"}
  else if (v[i,]$moth == 1) {mrace[i] <- "other"}
}

frace <- as.factor(c())
levels(frace) <- c("white", "black", "other")

for (i in 1:length(v$bwght)){
  
  if (v[i,]$fwhte == 1) {frace[i] <- "white"}
  else if (v[i,]$fblck == 1) {frace[i] <- "black"}
  else if (v[i,]$foth == 1) {frace[i] <- "other"}
}

table(mrace, frace)

# Could do a boxplot by race, e.g.:
boxplot(meduc ~ mrace, data = v)
# But black & other plots don't have a lot of data
```
### Correlation Analysis

We build a correlation matrix to identify pairs of variables that have high correlation relationship.
Looking at the corelation matrix below, we can see that the following are highly correlated:

- Race of the baby's mother and father
- Ages of the baby's mother and father
- Education level of the baby's mother and father

Also, the education levels of the mother and father correlate positively with the number of prenatal visits, indicating that highly educated parents tend to have more prenatal care visits and start them earlier.

```{r}
cor=cor(v)
corrplot(cor, method="circle",diag = FALSE)
```

# Model Specifications

### Outcome Variable

To evaluate the well-being of a newborn baby, we combine two measures of a newborn's well-being: its two APGAR scores, which evaluate the baby's health immediately after birth, and its birth weight. Since APGAR scores are measured on a 0-10 discrete scale while birth weight is continuous, we have transformed birth weight to 0-10 scale so it can be more easily combined with the APGAR scores. Our new outcome variable `health Score` is a weighted average of the one-minute APGAR score, 5-minute APGAR score, and birth weight score. We assume weight is more important than the APGAR scores in this exercise, so we give it a weight of 2 in the average formula.

```{r}
v$weightScore <- rescale(v$bwght,to=c(0,10))
# Note: weightScore not weighted in the formula below. Is 2 the correct weight?
v$healthScore <- (v$omaps+v$fmaps+v$weightScore)/3
hist(v$weightScore)
hist(v$healthScore)  
```

Unlike weight distribution, `healthScore` skews right, reflecting that the majority of newborn babies in the survey are in good health.

### Selection of Independent Variables

We will not include the variables `lbw` or `vlbw` in any model because these variables are a function of our outcome variable. In models 1 and 2 we will also exclude any variables that are highly correlated with each other, as determined in our **Correlation Analysis** section. For example, since we know that the mother's race and father's race have a correlation of 90%, we will not include them both in models 1 and 2.

### Model 1

Our first model contains only our variables of interest, which are the number of prenatal visits `npvis` and the month in which prenatal care began `monpre`. We use robust standard errors in all of our models.

```{r}
model1 <- lm(healthScore ~ monpre + npvis , data = v) 
coeftest(model1, vcov = vcovHC) 
plot(model1) 
summary(model1)$r.square
AIC(model1)
cor(v$monpre, v$npvis)

vif(model1)
bptest(model1)
hist(model1$residuals)
```
The coefficent variance test shows that `npvis` and `npvissq` are statistically significant. *Add some comments on the coefficients.*

However, our model's $R^2$ is very low. We need to include more covariates to explain the variation in newborn health, which we will do in our next model.

### Model 2

In Model 2, we add variables that we believe will improve the accuracy of our prediction *without introducing bias*.

We add an indicator for the baby's gender and the variables that are related to the mother and her behavior: age, education, race, drinks per week, and cigarettes per day. We do not include information on the father's age, education, or race, since the mother's and father's information is highly correlated.

```{r}
model2 <- lm(healthScore ~ monpre + npvis + npvissq + male + cigs + drink + mage + meduc + mwhte + mblck, data = v)
coeftest(model2, vcov = vcovHC) # Significant vars: monpre (still positive), npvis, cigs, mage, male, moth
plot(model2) # Meets assumptions relatively well
AIC(model2) # Lower than model 1
summary(model2)$r.square
vif(model2)
bptest(model2)
```
-> Slight Improvement in accurancy (r squared improved and AIC is slightly reduced compared to model 1)

### Model 3

In Model 3, we include additional covariates that are problematic for our model, primarily because they are highly correlated with some of the variables we added in Model 2.

```{r}
model3 <- lm(healthScore ~ monpre + npvis+ cigs + drink + mage +magesq+  meduc +  male + mwhte +mblck+fwhte+fblck, data = v)
coeftest(model3, vcov = vcovHC) # Same significant vars as model 2 except suddenly race coeficients become significant 
plot(model3) # Meets assumptions relatively well
AIC(model3) # Basically the same as model 2
summary(model3)$r.square
vif(model3)
```

Some interesting effects now show up. mblck and mwhte coefficients now become significant but with negative values. This can be explained that in fact race is not significant but because we include highly correlated variables in, together they distort the test.  Father race have positive coefficient which is offsetted by negative coefficient values of mother race.
Also, the VIF score show high values for all race variables which cleary mean the model become multicollinear.


# Assessment of CLM Assumptions

### Model 1

- CLM1: ...
- CLM2: ...
- CLM3: No perfect collinearity but vif for both `npvis` and `npvissq` are high. This shows that this model is subject to a multicollinearity problem.
- CLM4: Zero conditional mean ok
- CLM5: Based on the graph, it looks like the data isnâ€™t homoskedastic and shows that we should reject the null, meaning the data is hetroskedastic
- CML6: data is not good at first but turn to normal with larger value 

### Model 2

### Model 3

# Summary of Results

# Causality

# Conclusion
